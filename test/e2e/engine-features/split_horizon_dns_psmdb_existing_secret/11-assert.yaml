apiVersion: kuttl.dev/v1
kind: TestAssert
timeout: 180
collectors:
  - command: kubectl get splitdns/shdc-psmdb -n ${NAMESPACE} -o yaml
  - command: kubectl get secret/shdc-secret-exists -n ${NAMESPACE} -o yaml
  - command: kubectl get db/psmdb-shdc -n ${NAMESPACE} -o yaml
  - command: kubectl get psmdb/psmdb-shdc -n ${NAMESPACE} -o yaml
  - type: pod
    namespace: everest-system
    selector: control-plane=controller-manager
    tail: 100
resourceRefs:
  - apiVersion: enginefeatures.everest.percona.com/v1alpha1
    kind: SplitHorizonDNSConfig
    name: shdc-psmdb
    ref: shdc
  - apiVersion: everest.percona.com/v1alpha1
    kind: DatabaseCluster
    name: psmdb-shdc
    ref: db
  - apiVersion: psmdb.percona.com/v1
    kind: PerconaServerMongoDB
    name: psmdb-shdc
    ref: psmdb
assertAll:
  - celExpr: "has(shdc.metadata.finalizers)"
    message: "shdc doesn't have finalizers"

  - celExpr: "!shdc.metadata.finalizers.exists(k, k == 'everest.percona.com/cleanup-secrets')"
    message: "'everest.percona.com/cleanup-secrets' presents in shdc.metadata.finalizers"

  - celExpr: "'everest.percona.com/in-use-protection' in shdc.metadata.finalizers"
    message: "'everest.percona.com/in-use-protection' is absent in shdc.metadata.finalizers"

  - celExpr: "!has(shdc.spec.tls.certificate)"
    message: "shdc has unexpected .spec.tls.certificate"

  - celExpr: "has(psmdb.spec.replsets[0].splitHorizons)"
    message: "psmdb.spec.replsets[0].splitHorizons is empty"

  - celExpr: "psmdb.spec.replsets[0].splitHorizons.exists(k, k == 'psmdb-shdc-rs0-0')"
    message: "psmdb.spec.replsets[0].splitHorizons.psmdb-shdc-rs0-0 is empty"

  - celExpr: "psmdb.spec.replsets[0].splitHorizons['psmdb-shdc-rs0-0'].exists(k, k == 'external')"
    message: "psmdb.spec.replsets[0].splitHorizons.psmdb-shdc-rs0-0.external is empty"

  - celExpr: "psmdb.spec.replsets[0].splitHorizons.exists(k, k == 'psmdb-shdc-rs0-1')"
    message: "psmdb.spec.replsets[0].splitHorizons.psmdb-shdc-rs0-1 is empty"

  - celExpr: "psmdb.spec.replsets[0].splitHorizons['psmdb-shdc-rs0-1'].exists(k, k == 'external')"
    message: "psmdb.spec.replsets[0].splitHorizons.psmdb-shdc-rs0-1.external is empty"

  - celExpr: "psmdb.spec.replsets[0].splitHorizons.exists(k, k == 'psmdb-shdc-rs0-2')"
    message: "psmdb.spec.replsets[0].splitHorizons.psmdb-shdc-rs0-2 is empty"

  - celExpr: "psmdb.spec.replsets[0].splitHorizons['psmdb-shdc-rs0-2'].exists(k, k == 'external')"
    message: "psmdb.spec.replsets[0].splitHorizons.psmdb-shdc-rs0-2.external is empty"
commands:
  - command: kubectl wait --for=jsonpath='{.spec.replsets[0].splitHorizons.psmdb-shdc-rs0-0.external}'=psmdb-shdc-rs0-0-${NAMESPACE}.mycompany.com psmdb/psmdb-shdc -n ${NAMESPACE}
  - command: kubectl wait --for=jsonpath='{.spec.replsets[0].splitHorizons.psmdb-shdc-rs0-1.external}'=psmdb-shdc-rs0-1-${NAMESPACE}.mycompany.com psmdb/psmdb-shdc -n ${NAMESPACE}
  - command: kubectl wait --for=jsonpath='{.spec.replsets[0].splitHorizons.psmdb-shdc-rs0-2.external}'=psmdb-shdc-rs0-2-${NAMESPACE}.mycompany.com psmdb/psmdb-shdc -n ${NAMESPACE}
---
apiVersion: enginefeatures.everest.percona.com/v1alpha1
kind: SplitHorizonDNSConfig
metadata:
  name: shdc-psmdb
spec:
  baseDomainNameSuffix: mycompany.com
  tls:
    secretName: shdc-secret-exists
status:
  inUse: true
---
apiVersion: v1
kind: Secret
metadata:
  name: shdc-secret-exists
type: Opaque
data:
  ca.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBdmJZczVCa2xqSHRKckZkOFNnc0xhNzZvQ1FVQWdTcU1OdkZKVWxMSjBtMlM4eDI1ClZHWGFPWDM5Q1hHKzIxTzg5VGRoWHRRSU5nMEoxbTdmSlVFMDVGS2xKVTBPUWxRV2hETDNKWFF6UUdJc0FZV1YKV3Rib1VybjJvZVNoWHJmYkhOR3J4YnlmRitkcEJPRlpLY0pwU3Nta0ROMjVIVjlXbHdqdHFEVi9qZW92UHMvbgpPUm9VS0RJRjlSRUVwemtkbVNSbjlBNlBPb1A1UlJ6VkYzWTNlQ3JEK0RRbnQ3Qm5ndEtnWGZqbUg0RDJtSHZmCnBtWWJ0T3pjRzhNRXpBNGZaMldib2o3QlUxYTdZUmxiOVBGN1N1b1hBdldRMUJxNHlmWDN2em1KcjQ5RWZtRWoKbW4xZjdSeFdqV2M2QmxXaUFsVzFqeWJOc2VoZXl3MS9LSjk3V1FJREFRQUJBb0lCQUJZVzI1YUNGcEVMVEc1aQpuK1JUc2FSZHBsMXBmWS9zb3plbEErVnY0aFBNUWlWb2J6dEVZa0xhT0grMFpMV1BSQ1BWeTFMQ004UU9ZOWc1CjMrWHJ1Q1BET3pzekJBOWxVTnRhLzFPM09sMzdhRllUaHFyVmRlYm5CQkNBNldpNDFleWV2Y1pZQW5yRExVTmUKRlZhVFRsVUEwa2NVdkpDTzJLdGNwT1oyZHpnUDZpQ3BiUmNPUGVieDdHZXNiS2ZaRkxSOUNUSlgvUXY0YUFvMQpvL3BLYTZEeXk4V0MzNWtxOWQ3cTk4dmV1T3VMSWxPZ0k3UGdYMVBxUHJIOCs1OEI2YUduaC9Oa1VWMkd6OExKCkNSQmZoZW5RQ2EyVkM5UU9qLzhsbEVWdERTMXlNUEFUcG14ZWRESjI4ODNtWjRxNllaUjM3T0VVTVdUSWtzUWgKY0RNZUNlRUNnWUVBL0FSbldZUzFhYjQxeDVtcVlmbnhXMktvQmxvTm5LbWZGa1IvZEVqWE1ReEc3eFFSSTBNTAovenRHcUxxUHlaRGVNVGQ3ZzZVOHVmWWVPMURMQ3RjK3JwRlFVSWt1aHdxUEpVRVNiRUhMYzcvSkF5czREaUcvClVPWEJRd21RQmdlazVFaW9IaHhCNWQyWE4xTk5iemFnOFZsZkF4WDhlQnhFejFZa2RFZ0NQT0VDZ1lFQXdMV3oKRFFMaFNndW5pQjhZaXFmalQyaldZREF1NHY0ays5L1Izc1BkTm9xOVpCRk16VWE3N25pWFFOTUpFaVg5V2I2SQp2ZDBBdTAzdzdFYTNmbDIycWtmWHljQ1ZsYWxXVXJ5VjFyamxHS013VytEeEVHbUpYRWtEek1ycnRINU8xS0VCCmpFRWtPTC92Wkl6Z245UHNRSHNXTWdTbXFONDNmUCtjamdLYVZYa0NnWUJMRWZ5L083cldidVNTT29INGdYMlYKM1VOejhPdFJHVzNjTWpkTktrMS92TXA4ZVJ2Snh6VVJxRlNaK2tqT29DcXZ1bmsrYzhBdEhOVlFrZmFKbWloLwowNlY2K0FJMkU3MGtPY2dGRzJ4QlpJVzZQZXVLdWg3Rk9FdGpicnZLTUFpOFA3QmtsOEpCZU1xTW5uSFlpUXRVCkdXMGwvQ3lpa3Jra2tlSjJDT1V4d1FLQmdFUVVyUkh1cjRyS1BVQ1F3OG5RY0RUUXM5TzlrZ0x0aUVGWG5EeFgKOCtIZDkvVFBTOVBGcG9Va0kwTnFpdXpYY1A3d21qeUJSRTNueGpLaTlSWjJveDdiVExmaENyZVo0SDVRVTV0TgpMTnFjWkd4Qk5zajJqK21EZmcwdXIwRFAwcWU1emVNdjdFMEVPZDNMQzF4THNVNUNiZC96MXJFWCtJQjNpV1orCk11bjVBb0dCQUsyV3E0dFlOeWxQZVpiK2RiWWRUSmlPTkswYVdmZEs1WkpxSXdmcXNhb2xPdUIyVnhvVDVoWGkKQml4YWYwWFlPL3JlVUd1SjR5dXNQRzNOZEdEZ1h5cHFoWFU3Z2xRSmQ4SUMxMDh5elVPQjNOZy8xRGtkRjYrdwpPUWdLdmpvUXVaWDc0bkdUWG1lL3ZDSVhQRjB3Sy9IaFhhemZyWlIzMjc2VDkwQkUzdndECi0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==
  ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURGRENDQWZ5Z0F3SUJBZ0lVWTlLTWtlTC82RVhQaitWTjQ0N0hvWUY1TlpVd0RRWUpLb1pJaHZjTkFRRUwKQlFBd0lqRU9NQXdHQTFVRUNoTUZVRk5OUkVJeEVEQU9CZ05WQkFNVEIxSnZiM1FnUTBFd0hoY05NalV4TVRBMQpNRGMxTmpBd1doY05NekF4TVRBME1EYzFOakF3V2pBaU1RNHdEQVlEVlFRS0V3VlFVMDFFUWpFUU1BNEdBMVVFCkF4TUhVbTl2ZENCRFFUQ0NBU0l3RFFZSktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0NnZ0VCQUwyMkxPUVoKSll4N1NheFhmRW9MQzJ1K3FBa0ZBSUVxakRieFNWSlN5ZEp0a3ZNZHVWUmwyamw5L1FseHZ0dFR2UFUzWVY3VQpDRFlOQ2RadTN5VkJOT1JTcFNWTkRrSlVGb1F5OXlWME0wQmlMQUdGbFZyVzZGSzU5cUhrb1Y2MzJ4elJxOFc4Cm54Zm5hUVRoV1NuQ2FVckpwQXpkdVIxZlZwY0k3YWcxZjQzcUx6N1A1emthRkNneUJmVVJCS2M1SFpra1ovUU8KanpxRCtVVWMxUmQyTjNncXcvZzBKN2V3WjRMU29GMzQ1aCtBOXBoNzM2Wm1HN1RzM0J2REJNd09IMmRsbTZJKwp3Vk5XdTJFWlcvVHhlMHJxRndMMWtOUWF1TW4xOTc4NWlhK1BSSDVoSTVwOVgrMGNWbzFuT2daVm9nSlZ0WThtCnpiSG9Yc3NOZnlpZmUxa0NBd0VBQWFOQ01FQXdEZ1lEVlIwUEFRSC9CQVFEQWdFR01BOEdBMVVkRXdFQi93UUYKTUFNQkFmOHdIUVlEVlIwT0JCWUVGRzVXeWtBb2d0OG1hNzRTeXRxeXhxTS9TMm1NTUEwR0NTcUdTSWIzRFFFQgpDd1VBQTRJQkFRQ2pmeU5oaDF2cjN3MVZXalRLajl4bUNrMU9YK1pBcVI3NkpkWkk0UHhnQ1hRQkNid1d6enBLCmtmeEFTTUowNE5LYnJFZ0tnWXczNG96clNvbVlMZndETm82czlLenBBZEQ2Z2F3Q0dPZXEzNzM4T3BSSU44YTkKNENZM0ZMRCs4emExcVI0ZkVtV1dOdnFvNlBNeDE3VGVjK092WnhJcTRXakZlRDRnZ3pYeWhqMTZzSGE2Z2YyYQphbjZvbktVVnhsYTdtTGdhY2taRzNXOTdOMlNBcXR3U252d3luYXNvaWFSeEM4OTRweC9FbnpNeXcwMElqeEFkCjZGMndWYVpqWmhBRDlRMkdIV29iS0RWK05LUDYxaXVWQjA4NVJZWWxVTXBxd3J4bkhBWllJQjk4SXJmVjFyRlUKQUhQOWRFNnVqMnFvTDQyWE5rN0ZvamJJRmw4RWIyRXQKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
---
apiVersion: everest.percona.com/v1alpha1
kind: DatabaseCluster
metadata:
  name: psmdb-shdc
spec:
  engineFeatures:
    psmdb:
      splitHorizonDnsConfigName: shdc-psmdb
status:
  status: ready
---
apiVersion: psmdb.percona.com/v1
kind: PerconaServerMongoDB
metadata:
  name: psmdb-shdc
spec:
  secrets:
    ssl: psmdb-shdc-sh-cert
    sslInternal: psmdb-shdc-ssl-internal
status:
  state: ready
