apiVersion: kuttl.dev/v1
kind: TestStep
timeout: 10
commands:
  # NOTE: do not change the Secrets, we need the exact credentials for the restore.
  - script: |
      cat <<EOF | kubectl apply -f -
      apiVersion: v1
      data:
        monitor: KF1iWU5ifUgzdW11d0NqQA==
        operator: QWo+ZVhiaz9PTDJVeUVZag==
        proxyadmin: U3lHTjV2TDdsan1Bej1PeEBh
        replication: PyMkUnc2YlNMQT5LSEQyY1o=
        root: U0woVWE8a1cwNFteKSh4enI=
        xtrabackup: TnVNMEk+LGFseVRBNFM4YX0=
      kind: Secret
      metadata:
        name: everest-secrets-test-pxc-cluster
        namespace: ${NAMESPACE}
      type: Opaque
      EOF
  - script: |
      cat <<EOF | kubectl apply -f -
      apiVersion: everest.percona.com/v1alpha1
      kind: DatabaseCluster
      metadata:
        name: test-pxc-cluster
        namespace: ${NAMESPACE}
      spec:
        dataSource:
          dataImport:
            dataImporterName: everest-percona-pxc-operator
            source:
              path: "/pxc"
              s3:
                bucket: everest-operator
                region: us-east-1
                endpointURL: https://minio.${NAMESPACE}.svc
                credentialsSecretName: test-s3-secret
                verifyTLS: false
                forcePathStyle: true
        engine:
          type: pxc
          userSecretsName: everest-secrets-test-pxc-cluster
          replicas: 3
          storage:
            size: 1G
          resources:
            cpu: 1
            memory: 500M
        proxy:
          type: haproxy
          replicas: 3
          resources:
            cpu: "1"
            memory: 30M
      EOF
---
apiVersion: v1
kind: Secret
metadata:
  name: test-s3-secret
stringData:
  AWS_ACCESS_KEY_ID: minioadmin
  AWS_SECRET_ACCESS_KEY: minioadmin