apiVersion: kuttl.dev/v1
kind: TestAssert
timeout: 100
collectors:
  - command: kubectl get db/test-pxc-cluster -n ${NAMESPACE} -o yaml
  - command: kubectl get pxc/test-pxc-cluster -n ${NAMESPACE} -o yaml
  - type: pod
    namespace: everest-system
    selector: control-plane=controller-manager
    tail: 100
commands:
  - command: kubectl wait --for=jsonpath='{.spec.dataSource.dataImport.source.s3.endpointURL}'='https://minio.${NAMESPACE}.svc' db/test-pxc-cluster -n ${NAMESPACE}
---
apiVersion: everest.percona.com/v1alpha1
kind: DatabaseCluster
metadata:
  name: test-pxc-cluster
spec:
  dataSource:
    dataImport:
      dataImporterName: everest-percona-pxc-operator
      source:
        path: "/pxc"
        s3:
          bucket: everest-operator
          region: us-east-1
          credentialsSecretName: test-s3-secret
          verifyTLS: false
          forcePathStyle: true
  engine:
    replicas: 3
    type: postgresql
  proxy:
    replicas: 3
status:
  status: initializing
---
apiVersion: pxc.percona.com/v1
kind: PerconaXtraDBCluster
metadata:
  name: test-pxc-cluster
spec:
  pxc:
    size: 3
  haproxy:
    size: 3
status:
  state: initializing
