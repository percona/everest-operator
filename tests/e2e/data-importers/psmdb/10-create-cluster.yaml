apiVersion: kuttl.dev/v1
kind: TestStep
timeout: 10
commands:
  # NOTE: These credentials are required for the data importer to correcty restore.
  - script: |
      cat <<EOF | kubectl apply -f -
      apiVersion: v1
      data:
        MONGODB_BACKUP_PASSWORD: REhYa254SDNuS2IwU1g1Rko=
        MONGODB_BACKUP_USER: YmFja3Vw
        MONGODB_CLUSTER_ADMIN_PASSWORD: VTRxdkFVVU1hZTZoaDBUdzg=
        MONGODB_CLUSTER_ADMIN_USER: Y2x1c3RlckFkbWlu
        MONGODB_CLUSTER_MONITOR_PASSWORD: bWNhU3JoTGdtRDNvU21FNTZ0SQ==
        MONGODB_CLUSTER_MONITOR_USER: Y2x1c3Rlck1vbml0b3I=
        MONGODB_DATABASE_ADMIN_PASSWORD: T0I3bEo3TkRlbnVwT2VkdA==
        MONGODB_DATABASE_ADMIN_USER: ZGF0YWJhc2VBZG1pbg==
        MONGODB_USER_ADMIN_PASSWORD: Tmg1VkR3R0JwRGJtcER2YVo5Yg==
        MONGODB_USER_ADMIN_USER: dXNlckFkbWlu
      kind: Secret
      metadata:
        name: everest-secrets-test-psmdb-cluster
        namespace: ${NAMESPACE}
      type: Opaque
      EOF
  - script: |
      cat <<EOF | kubectl apply -f -
      apiVersion: everest.percona.com/v1alpha1
      kind: DatabaseCluster
      metadata:
        name: test-psmdb-cluster
        namespace: ${NAMESPACE}
      spec:
        dataSource:
          dataImport:
            dataImporterName: everest-percona-psmdb-operator
            source:
              path: "/psmdb/2025-07-14T10:52:52Z"
              s3:
                bucket: everest-operator
                region: us-east-1
                endpointURL: https://minio.${NAMESPACE}.svc
                credentialsSecretName: test-s3-secret
                verifyTLS: false
                forcePathStyle: true
        engine:
          type: psmdb
          replicas: 3
          storage:
            size: 1Gi
          resources:
            cpu: 1
            memory: 500M
          userSecretsName: everest-secrets-test-psmdb-cluster
        proxy:
          type: mongos
          replicas: 3
          resources:
            cpu: "1"
            memory: 30M
      EOF
---
apiVersion: v1
kind: Secret
metadata:
  name: test-s3-secret
stringData:
  AWS_ACCESS_KEY_ID: minioadmin
  AWS_SECRET_ACCESS_KEY: minioadmin
