apiVersion: kuttl.dev/v1
kind: TestStep
timeout: 120
commands:
  - script: |-
     IMAGE="$(kubectl get -n ${NAMESPACE} psmdb/test-psmdb-cluster -o jsonpath='{.spec.image}')"
     PSMDBPASSWORD="$(kubectl get -n ${NAMESPACE} secret/everest-secrets-test-psmdb-cluster -o jsonpath='{.data.MONGODB_DATABASE_ADMIN_PASSWORD}' | base64 --decode)"
     PSMDBUSER="databaseAdmin"
     PSMDBHOST="$(kubectl get -n ${NAMESPACE} db/test-psmdb-cluster -o jsonpath='{.status.hostname}')"
     CONN_URI="mongodb://${PSMDBUSER}:${PSMDBPASSWORD}@${PSMDBHOST}:27017/admin?replicaSet=rs0&ssl=false"


     kubectl run -n "${NAMESPACE}" psmdb-client --env="CONN_URI=${CONN_URI}" --env="NO_COLOR=1" --image=${IMAGE} --restart=Never --command -- sleep infinity
