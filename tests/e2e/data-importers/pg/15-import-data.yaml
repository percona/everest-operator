apiVersion: kuttl.dev/v1
kind: TestStep
timeout: 300
commands:
  - script: |
      PGUSER=postgres
      PGPASSWORD="$(kubectl get secret -n $NAMESPACE test-pg-cluster-user-secret -o jsonpath='{.data.password}' | base64 --decode)"
      PGHOST="$(kubectl get db -n $NAMESPACE test-pg-cluster -o jsonpath='{.status.hostname}')"

      cat <<EOF | ${OPERATOR_BIN_DIR}/data-importer pg -
      {
        "source": {
          "path": "/pg/backup/db/20250630-053413F",
          "s3": {
            "accessKeyID": "${MINIO_ACCESS_KEY}",
            "secretKey": "${MINIO_SECRET_KEY}",
            "bucket": "${MINIO_BUCKET_NAME}",
            "endpointURL": "https://minio.${NAMESPACE}.svc",
            "region": "${MINIO_REGION}",
            "forcePathStyle": true,
            "verifyTLS": false
          }
        },
        "target": {
          "databaseClusterRef": {
            "name": "test-pg-cluster",
            "namespace": "${NAMESPACE}"
          },
          "host": "${PGHOST}",
          "port": "5432",
          "user": "${PGUSER}",
          "password": "${PGPASSWORD}"
        }
      }
      EOF
    skipLogOutput: false
