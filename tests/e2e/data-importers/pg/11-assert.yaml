apiVersion: kuttl.dev/v1
kind: TestAssert
timeout: 300
collectors:
  - command: kubectl get db/test-pg-cluster -n ${NAMESPACE} -o yaml
  - command: kubectl get perconapgcluster/test-pg-cluster -n ${NAMESPACE} -o yaml
  - command: kubectl get dataimportjob/data-import-test-pg-cluster -n ${NAMESPACE} -o yaml
  - command: kubectl get job -n ${NAMESPACE} -o yaml
  - type: pod
    namespace: everest-system
    selector: control-plane=controller-manager
    tail: 100
commands:
  - command: kubectl wait --for=jsonpath='{.spec.source.s3.endpointURL}'='https://minio.${NAMESPACE}.svc' dataimportjob/data-import-test-pg-cluster -n ${NAMESPACE}
---
apiVersion: everest.percona.com/v1alpha1
kind: DatabaseCluster
metadata:
  name: test-pg-cluster
status:
  status: importing
---
apiVersion: pgv2.percona.com/v2
kind: PerconaPGCluster
metadata:
  name: test-pg-cluster
status:
  state: initializing
---
apiVersion: everest.percona.com/v1alpha1
kind: DataImportJob
metadata:
  labels:
    clusterName: test-pg-cluster
  name: data-import-test-pg-cluster
  ownerReferences:
    - apiVersion: everest.percona.com/v1alpha1
      blockOwnerDeletion: true
      controller: true
      kind: DatabaseCluster
      name: test-pg-cluster
spec:
  dataImporterName: everest-percona-pg-operator
  source:
    path: /pg/backup/db/20250702-131148F
    s3:
      bucket: everest-operator
      credentialsSecretName: test-s3-secret
      forcePathStyle: true
      region: us-east-1
      verifyTLS: false
  targetClusterName: test-pg-cluster
status:
  state: Running
---
apiVersion: batch/v1
kind: Job
metadata:
  ownerReferences:
    - apiVersion: everest.percona.com/v1alpha1
      blockOwnerDeletion: true
      controller: true
      kind: DataImportJob
      name: data-import-test-pg-cluster
spec:
  template:
    spec:
      containers:
        - args:
            - /payload/request.json
          command:
            - /data-importer
            - pg
          image: perconalab/everest-operator:0.0.0
          name: importer
          volumeMounts:
            - mountPath: /payload
              name: payload
              readOnly: true
      serviceAccountName: data-import-test-pg-cluster-sa
      volumes:
        - name: payload
