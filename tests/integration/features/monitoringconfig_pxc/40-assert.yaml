apiVersion: kuttl.dev/v1
kind: TestAssert
timeout: 30
collectors:
  - command: kubectl -n $NAMESPACE get db/pxc-mc -o yaml
  - command: kubectl -n $NAMESPACE get monitoringconfig/test-mc -o yaml
  - command: kubectl -n $NAMESPACE get secret/mc-secret -o yaml
  - command: kubectl -n $NAMESPACE get pxc/pxc-mc -o yaml
  - command: kubectl -n $NAMESPACE get secret/everest-secrets-pxc-mc -o yaml
commands:
  - script: |-
      set -o errexit
      db_monitoring_spec=$(kubectl get -n $NAMESPACE db/pxc-mc -o jsonpath='{.spec.monitoring.monitoringConfigName}')
      echo "db_monitoring_spec: $db_monitoring_spec"
      [ -z "$db_monitoring_spec" ] && exit 0 || exit 2

  - script: |-
      set -o errexit
      pmm_spec=$(kubectl get -n $NAMESPACE pxc/pxc-mc -o jsonpath='{.spec.pmm.enabled}')
      echo "pmm_spec: $pmm_spec"
      [ -z "$pmm_spec" ] && exit 0 || exit 2
---
apiVersion: everest.percona.com/v1alpha1
kind: DatabaseCluster
metadata:
  name: pxc-mc
  labels:
    clusterName: pxc-mc
spec:
  monitoring:
    resources:
      limits:
        memory: "128Mi"
        cpu: "500m"
---
apiVersion: everest.percona.com/v1alpha1
kind: MonitoringConfig
metadata:
  name: test-mc
  finalizers:
    - everest.percona.com/vmagent
spec:
  type: pmm
  credentialsSecretName: mc-secret
  verifyTLS: false
  pmm:
    url: http://localhost2
    image: percona/pmm-client:2
status:
  inUse: false
---
apiVersion: v1
kind: Secret
metadata:
  name: mc-secret
  ownerReferences:
    - apiVersion: everest.percona.com/v1alpha1
      blockOwnerDeletion: true
      controller: true
      kind: MonitoringConfig
      name: test-mc
type: Opaque
data:
  apiKey: YXNkZmcxMjM=
---
apiVersion: pxc.percona.com/v1
kind: PerconaXtraDBCluster
metadata:
  name: pxc-mc
spec:
  pmm:
    resources:
      limits:
        memory: "300M"
        cpu: "500m"
  secretsName: everest-secrets-pxc-mc
---
apiVersion: v1
kind: Secret
metadata:
  name: everest-secrets-pxc-mc
type: Opaque
data:
  pmmserverkey: YXNkZmcxMjM=
